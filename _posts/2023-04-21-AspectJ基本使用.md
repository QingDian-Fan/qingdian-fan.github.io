---
title: AspectJ基本使用
tags: 其他
permalink: android-source/dc-other-4
key: android-source-dc-other-4
sidebar:
  nav: android-source
---

## 一、环境配置

**本文使用的相关工具版本如下**
- AndroidStudio 4.0.2
- gradle 6.1.1

### NDK 是什么

NDK全称：Native Development Kit

原生开发套件 (NDK) 是一套工具，使您能够在 Android 应用中使用 C 和 C++ 代码，并提供众多[平台库](https://developer.android.google.cn/ndk/guides/stable_apis)，您可使用这些平台库管理原生 activity 和访问实体设备组件，例如传感器和触控输入。NDK 可能不适合大多数 Android 编程初学者，这些初学者只需使用 Java 代码和框架 API 开发应用。然而，如果您需要实现以下一个或多个目标，那么 NDK 就能派上用场：

-   进一步提升设备性能，以降低延迟或运行游戏或物理模拟等计算密集型应用。
-   重复使用您自己或其他开发者的 C 或 C++ 库。

<!--more-->

```groovy
implementation 'org.aspectj:aspectjrt:1.9.6'
```



```
classpath 'org.aspectj:aspectjtools:1.9.6'
classpath 'org.aspectj:aspectjweaver:1.9.6'
```



```
//aop aspectj
import org.aspectj.bridge.IMessage
import org.aspectj.bridge.MessageHandler
import org.aspectj.tools.ajc.Main

android.applicationVariants.all { variant ->

    variant.outputs.all { output ->
        def buildTime = project.hasProperty('BUILD_TIME') ? BUILD_TIME : new Date().format("yyyyMMdd", TimeZone.getTimeZone("GMT+08:00"))

        def newPath = outputFileName.replace(".apk", "-${variant.versionName}-${buildTime}.apk")
        outputFileName = new File("玩Android", newPath)

        def fullName = ""
        output.name.tokenize('-').eachWithIndex { token, index ->
            fullName = fullName + (index == 0 ? token : token.capitalize())
        }

        JavaCompile javaCompile = variant.javaCompiler

        MessageHandler handler = new MessageHandler(true)
        javaCompile.doLast {
            String[] javaArgs = ["-showWeaveInfo",
                                 "-1.8",
                                 "-inpath", javaCompile.destinationDir.toString(),
                                 "-aspectpath", javaCompile.classpath.asPath,
                                 "-d", javaCompile.destinationDir.toString(),
                                 "-classpath", javaCompile.classpath.asPath,
                                 "-bootclasspath", project.android.bootClasspath.join(
                    File.pathSeparator)]

            String[] kotlinArgs = ["-showWeaveInfo",
                                   "-1.8",
                                   "-inpath", project.buildDir.path + "/tmp/kotlin-classes/" + fullName,
                                   "-aspectpath", javaCompile.classpath.asPath,
                                   "-d", project.buildDir.path + "/tmp/kotlin-classes/" + fullName,
                                   "-classpath", javaCompile.classpath.asPath,
                                   "-bootclasspath", project.android.bootClasspath.join(
                    File.pathSeparator)]

            new Main().run(javaArgs, handler)
            new Main().run(kotlinArgs, handler)

            def log = project.logger
            for (IMessage message : handler.getMessages(null, true)) {
                switch (message.getKind()) {
                    case IMessage.ABORT:
                    case IMessage.ERROR:
                    case IMessage.FAIL:
                        log.error message.message, message.thrown
                        break
                    case IMessage.WARNING:
                    case IMessage.INFO:
                        log.info message.message, message.thrown
                        break
                    case IMessage.DEBUG:
                        log.debug message.message, message.thrown
                        break
                }
            }
        }
    }

}
```





```
@Retention(AnnotationRetention.RUNTIME)
@Target(
    AnnotationTarget.FUNCTION,
    AnnotationTarget.PROPERTY_GETTER,
    AnnotationTarget.PROPERTY_SETTER
)
annotation class CheckPermissions constructor(
    /**
     * 需要申请权限的集合
     */
    vararg  val value: String,
    val isMust:Boolean = false
)
```





```
@Aspect
class CheckPermissionsAspect {

    @Pointcut("execution(@com.dian.demo.utils.aop.CheckPermissions * *(..))")
    fun methodPermissions() {

    }

    @Around("methodPermissions()")
    @Throws(Throwable::class)
    fun aroundJoinPermissions(joinPoint: ProceedingJoinPoint) {
        LogUtil.e("TAGTAG", "AOP-CheckPermissions")
        var mActivity: AppCompatActivity? = null
        for (arg in joinPoint.args) {
            if (arg is AppCompatActivity) {
                mActivity = arg
                break
            }
        }
        if ((mActivity == null) || mActivity.isFinishing || mActivity.isDestroyed) {
            LogUtil.e("TAGTAG", "AOP-CheckPermissions-mActivity is null")
            mActivity = ActivityManager.getInstance().getTopActivity() as AppCompatActivity
        }
        val methodSignature = joinPoint.signature as MethodSignature
        val method = methodSignature.method
        if (method === null || !method.isAnnotationPresent(CheckPermissions::class.java)) {
            return
        }
        val checkPermissions = method.getAnnotation(CheckPermissions::class.java)
        val permissionList: Array<out String> = checkPermissions?.value ?: arrayOf()
        val isMustPermission = checkPermissions?.isMust
        LogUtil.e("TAGTAG", "AOP-CheckPermissions-do it")
        if (PermissionsUtil.hasAopPermission(mActivity, permissionList)) {
            joinPoint.proceed()
        } else {
            requestPermissions(joinPoint, mActivity, permissionList, isMustPermission ?: false)
        }
    }

    private fun requestPermissions(
        joinPoint: ProceedingJoinPoint,
        mActivity: AppCompatActivity,
        permissions: Array<out String>,
        isMustPermission: Boolean
    ) {
        LivePermissions(mActivity).requestArray(permissions)
            .observe(mActivity) {
                when (it) {
                    is PermissionResult.Grant -> {  //权限允许
                        joinPoint.proceed()
                    }
                    is PermissionResult.Rationale -> {  //权限拒绝
                        if (isMustPermission) {
                            val dialog = TipDialog.getDialog("提示", "请到设置中打开权限，否则无法使用该功能")
                            dialog.showAllowStateLoss(mActivity.supportFragmentManager, "")
                        } else {
                            joinPoint.proceed()
                        }
                    }
                    is PermissionResult.Deny -> {   //权限拒绝，且勾选了不再询问
                        if (isMustPermission) {
                            val dialog = ConfirmDialog.getDialog(
                                "提示",
                                "请到设置中打开权限，否则无法使用该功能",
                                "dian://setting"
                            )
                            dialog.showAllowStateLoss(mActivity.supportFragmentManager, "")
                        } else {
                            joinPoint.proceed()
                        }
                    }
                }
            }
    }
}
```





```
@CheckPermissions(
    Manifest.permission.CAMERA,
    Manifest.permission.READ_EXTERNAL_STORAGE,
    Manifest.permission.WRITE_EXTERNAL_STORAGE,
    isMust = false
)
fun toPage() {
    getTitleBarView().postDelayed({
        HomeActivity.start(this@SplashActivity)
        finish()
    }, 500)
}
```

